<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enregistrement Carte NFC sécurisé</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    text-align: center;
    margin: 0;
    background: linear-gradient(135deg, #6dd5ed, #2193b0);
    color: white;
    overflow-x: hidden;
  }
  h1 { margin-top: 20px; text-shadow: 0 2px 6px rgba(0,0,0,0.3); }
  button {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    color: white;
    border: none;
    padding: 15px 35px;
    margin: 15px;
    font-size: 18px;
    border-radius: 14px;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover { background: rgba(255,255,255,0.3); }
  #reader { width: 300px; margin: 20px auto; border-radius: 20px; overflow: hidden; }
  .glass-box {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(15px);
    padding: 20px;
    border-radius: 20px;
    margin: 20px auto;
    width: 85%;
    max-width: 400px;
  }
  input {
    width: 85%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    backdrop-filter: blur(5px);
  }
  #status { font-weight: bold; margin-top: 10px; }
  #counter { font-weight: bold; margin: 20px; }
  #settingsButton {
    position: fixed;
    bottom: 20px;
    right: 20px;
    font-size: 32px;
    cursor: pointer;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  }
  #settingsPanel {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    color: white;
    padding: 20px;
    border-radius: 20px 20px 0 0;
  }
  #settingsPanel h3 { margin-top: 0; }

  /* Page de sélection Apple/Android */
  #deviceChoice {
    margin-top: 50px;
  }
  #deviceChoice button {
    width: 80%;
    max-width: 300px;
    font-size: 20px;
  }
  #deviceChoice p {
    max-width: 300px;
    margin: 10px auto 30px;
    font-size: 16px;
  }

  /* Bouton NFC spécifique Android */
  #nfcScanBtn {
    background: #34A853;
    color: white;
    font-weight: bold;
    margin-top: 10px;
  }
</style>
</head>
<body>

<!-- Page de choix Apple/Android au chargement -->
<div id="deviceChoice">
  <h1>Choisissez votre appareil</h1>
  <button id="btnApple">🍎 iPhone (iOS)</button>
  <p>iPhone ne supporte pas encore le scan NFC via navigateur.<br>Le site fonctionnera avec scan QR uniquement.</p>
  <button id="btnAndroid">🤖 Android</button>
  <p>Android permet le scan NFC directement via ce site (Chrome).</p>
</div>

<!-- CONTENU PRINCIPAL -->
<div id="mainContent" style="display:none;">

  <h1 id="title">📡 Scanner votre Carte</h1>

  <!-- Boutons principaux -->
  <button id="tutorialBtn" onclick="showTutorial()">❓ Tutoriel</button>
  <button id="scanBtn" onclick="startScan()">📷 Scanner QR</button>
  <button id="manualBtn" onclick="manualEntry()">✏️ Remplir manuellement</button>
  <button id="deleteBtn" onclick="startDelete()">🗑️ Supprimer une carte</button>

  <!-- Bouton NFC pour Android uniquement -->
  <button id="nfcScanBtn" style="display:none;" onclick="startNfcScan()">📶 Scanner NFC</button>

  <div id="reader"></div>
  <p id="status"></p>

  <!-- Actions après scan -->
  <div id="actions" class="glass-box" style="display:none;">
    <h2 id="actionsTitle">Carte détectée</h2>
    <button onclick="requestPinAndProceed('read')">👁️ Lire</button>
    <button onclick="requestPinAndProceed('edit')">✏️ Éditer</button>
    <button onclick="rescan()">🔄 Rescanner</button>
  </div>

  <!-- Lecture -->
  <div id="readBox" class="glass-box" style="display:none;">
    <h2 id="readTitle">Informations de la carte</h2>
    <pre id="readInfo" style="white-space: pre-wrap; text-align: left;"></pre>
    <button onclick="closeRead()">Fermer</button>
  </div>

  <!-- Formulaire -->
  <div id="formContainer" class="glass-box" style="display:none;">
    <h2 id="formTitle">Modifier les informations</h2>
    <input type="text" id="firstName" placeholder="Prénom" />
    <input type="text" id="lastName" placeholder="Nom" />
    <input type="email" id="email" placeholder="Email" />
    <input type="tel" id="phone" placeholder="Téléphone" />
    <input type="password" id="pin" placeholder="Définir un code PIN (facultatif)" />
    <div style="margin-top:10px;">
      <button onclick="saveData()">💾 Enregistrer</button>
      <button onclick="closeForm()">❌ Fermer</button>
    </div>
  </div>

  <!-- Suppression -->
  <div id="deletePanel" class="glass-box" style="display:none;">
    <h2 id="deleteTitle">Supprimer une carte</h2>
    <button onclick="startScanForDelete()">📷 Scanner la carte à supprimer</button>
    <br><br>
    <button onclick="manualDeleteEntry()">✏️ Entrer le numéro manuellement</button>
    <br><br>
    <button onclick="closeDelete()">❌ Annuler</button>
  </div>

  <!-- Confirmation suppression -->
  <div id="confirmDeletePanel" class="glass-box" style="display:none;">
    <h3 id="confirmDeleteText"></h3>
    <button onclick="confirmDelete(true)">✅ Oui</button>
    <button onclick="confirmDelete(false)">❌ Non</button>
  </div>

  <!-- Code PIN -->
  <div id="pinPrompt" class="glass-box" style="display:none;">
    <h3 id="pinPromptText">Entrez le code PIN pour cette carte</h3>
    <input type="password" id="pinInput" placeholder="Code PIN" />
    <div style="margin-top:10px;">
      <button onclick="checkPin()">Valider</button>
      <button onclick="cancelPin()">Annuler</button>
    </div>
    <p id="pinError" style="color:#f88; font-weight:bold;"></p>
    <button id="forgotPinBtn" style="background: rgba(255,0,0,0.3); margin-top:10px;" onclick="forgotPin()">
      Code PIN oublié ?
    </button>
  </div>

  <!-- Déblocage PIN oublié -->
  <div id="forgotPinPanel" class="glass-box" style="display:none;">
    <h3 id="forgotPinText">Veuillez scanner la carte physiquement pour désactiver le code PIN</h3>
    <div id="forgotReader" style="width:300px; margin:auto;"></div>
    <button onclick="cancelForgotPin()">Annuler</button>
  </div>

  <p id="counter"></p>

  <!-- Réglages flottants -->
  <div id="settingsButton" onclick="toggleSettings()">⚙️</div>
  <div id="settingsPanel">
    <h3>⚙️ Réglages</h3>
    <button id="toggleThemeBtn" onclick="toggleTheme()">🌓 Thème clair/sombre</button>
    <select id="langSelect" onchange="changeLanguage(this.value)">
      <option value="fr">Français</option>
      <option value="en">English</option>
      <option value="es">Español</option>
      <option value="de">Deutsch</option>
    </select>
    <br /><br />
    <button onclick="toggleSettings()">❌ Fermer</button>
  </div>

<script>
  let currentCard = null;
  let currentAction = null; // "read" ou "edit"
  let awaitingPin = false;
  let html5QrCode;
  let html5QrCodeForgot;
  let nfcReader;

  // Texte multilangues ici (idem version précédente, à copier)
  const texts = {
    fr: {
      tutorial: "1️⃣ Cliquez sur Scanner\n2️⃣ Montrez votre carte\n3️⃣ Si elle est protégée par code PIN, entrez-le\n4️⃣ Sinon, choisissez Lire ou Éditer",
      scanning: "📷 Scannez la carte...",
      cardDetected: "✅ Carte détectée : ",
      noData: "Aucune donnée enregistrée.",
      dataSaved: "💾 Données enregistrées !",
      deleteConfirm: "Êtes-vous sûr de supprimer les données de la carte ",
      pinPrompt: "Entrez le code PIN pour cette carte",
      pinError: "Code PIN incorrect",
      enterCardNum: "Entrez le numéro de carte :",
      cardDeleted: "Données supprimées.",
      cancel: "Annuler",
      close: "Fermer",
      readInfoTitle: "Informations de la carte",
      editInfoTitle: "Modifier les informations",
      actionsTitle: "Carte détectée",
      deleteTitle: "Supprimer une carte",
      pinInputPlaceholder: "Code PIN",
      saveBtn: "💾 Enregistrer",
      readBtn: "👁️ Lire",
      editBtn: "✏️ Éditer",
      rescanBtn: "🔄 Rescanner",
      forgotPinBtn: "Code PIN oublié ?",
      forgotPinText: "Veuillez scanner la carte physiquement pour désactiver le code PIN",
      deleteAllConfirm: "Tout supprimer ?",
      totalRegistered: "👥 Total enregistrées : ",
      tutorialBtn: "❓ Tutoriel",
      scanBtn: "📷 Scanner QR",
      manualBtn: "✏️ Remplir manuellement",
      deleteBtn: "🗑️ Supprimer une carte",
      toggleThemeBtn: "🌓 Thème clair/sombre",
      resetDataBtn: "🗑️ Réinitialiser toutes les données",
      langLabel: "Langue"
    },
    en: {
      tutorial: "1️⃣ Click Scan\n2️⃣ Show your card\n3️⃣ If protected by PIN, enter it\n4️⃣ Then choose Read or Edit",
      scanning: "📷 Scanning...",
      cardDetected: "✅ Card detected: ",
      noData: "No data saved.",
      dataSaved: "💾 Data saved!",
      deleteConfirm: "Are you sure to delete data for card ",
      pinPrompt: "Enter PIN code for this card",
      pinError: "Wrong PIN code",
      enterCardNum: "Enter card number:",
      cardDeleted: "Data deleted.",
      cancel: "Cancel",
      close: "Close",
      readInfoTitle: "Card Information",
      editInfoTitle: "Edit Information",
      actionsTitle: "Card detected",
      deleteTitle: "Delete a card",
      pinInputPlaceholder: "PIN code",
      saveBtn: "💾 Save",
      readBtn: "👁️ Read",
      editBtn: "✏️ Edit",
      rescanBtn: "🔄 Rescan",
      forgotPinBtn: "Forgot PIN?",
      forgotPinText: "Please physically scan the card to disable the PIN",
      deleteAllConfirm: "Delete all data?",
      totalRegistered: "👥 Total registered: ",
      tutorialBtn: "❓ Tutorial",
      scanBtn: "📷 QR Scan",
      manualBtn: "✏️ Manual Entry",
      deleteBtn: "🗑️ Delete a card",
      toggleThemeBtn: "🌓 Light/Dark theme",
      resetDataBtn: "🗑️ Reset all data",
      langLabel: "Language"
    },
    // ... autres langues si besoin ...
  };

  function t(key) {
    const lang = document.documentElement.lang || 'fr';
    return (texts[lang] && texts[lang][key]) || texts.fr[key] || key;
  }

  // Mise à jour des textes (idem version précédente)
  function updateTexts() {
    document.getElementById('title').innerText = t('actionsTitle');
    document.getElementById('tutorialBtn').innerText = "❓ " + t('tutorialBtn').replace("❓ ","");
    document.getElementById('scanBtn').innerText = "📷 " + t('scanBtn').replace("📷 ","");
    document.getElementById('manualBtn').innerText = "✏️ " + t('manualBtn').replace("✏️ ","");
    document.getElementById('deleteBtn').innerText = "🗑️ " + t('deleteBtn').replace("🗑️ ","");
    document.getElementById('actionsTitle').innerText = t('actionsTitle');
    document.getElementById('readTitle').innerText = t('readInfoTitle');
    document.getElementById('formTitle').innerText = t('editInfoTitle');
    document.getElementById('deleteTitle').innerText = t('deleteTitle');
    document.getElementById('pinPromptText').innerText = t('pinPrompt');
    document.getElementById('pinInput').placeholder = t('pinInputPlaceholder');
    document.querySelector("#actions button:nth-child(1)").innerText = t('readBtn');
    document.querySelector("#actions button:nth-child(2)").innerText = t('editBtn');
    document.querySelector("#actions button:nth-child(3)").innerText = t('rescanBtn');
    document.getElementById('saveBtn').innerText = t('saveBtn');
    document.getElementById('forgotPinBtn').innerText = t('forgotPinBtn');
    document.getElementById('forgotPinText').innerText = t('forgotPinText');
    document.getElementById('deleteTitle').innerText = t('deleteTitle');
    document.getElementById('toggleThemeBtn').innerText = t('toggleThemeBtn');
  }

  // Affiche tutoriel
  function showTutorial() {
    alert(t('tutorial'));
  }

  // Compteur cartes
  function updateCounter() {
    let count = 0;
    for(let i=0; i<localStorage.length; i++) {
      if(localStorage.key(i).startsWith("card-")) count++;
    }
    document.getElementById('counter').innerText = t('totalRegistered') + count;
  }

  // Reset UI (idem)
  function resetUI() {
    ['status','actions','readBox','formContainer','deletePanel','confirmDeletePanel','pinPrompt','forgotPinPanel'].forEach(id=>{
      document.getElementById(id).style.display = "none";
    });
    document.getElementById('status').innerText = "";
  }

  // Scanner QR (idem)
  function startScan() {
    resetUI();
    document.getElementById('status').innerText = t('scanning');
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop();
        currentCard = decodedText;
        showActions();
      },
      (errorMessage) => {
        document.getElementById('status').innerText = t('scanning') + " " + errorMessage;
      }
    );
  }

  // Actions après scan (idem)
  function showActions() {
    resetUI();
    document.getElementById('actionsTitle').innerText = t('cardDetected') + currentCard;
    document.getElementById('actions').style.display = "block";
  }

  // Demande PIN puis lit ou édite (idem)
  function requestPinAndProceed(action) {
    currentAction = action;
    const saved = localStorage.getItem("card-" + currentCard);
    if(saved) {
      const data = JSON.parse(saved);
      if(data.pin) {
        awaitingPin = true;
        resetUI();
        document.getElementById('pinError').innerText = "";
        document.getElementById('pinPrompt').style.display = "block";
        document.getElementById('pinInput').value = "";
        return;
      }
    }
    proceedAction();
  }

  function checkPin() {
    const input = document.getElementById('pinInput').value.trim();
    const saved = localStorage.getItem("card-" + currentCard);
    if(saved) {
      const data = JSON.parse(saved);
      if(data.pin === input) {
        awaitingPin = false;
        proceedAction();
      } else {
        document.getElementById('pinError').innerText = t('pinError');
      }
    } else {
      awaitingPin = false;
      proceedAction();
    }
  }
  function cancelPin() {
    awaitingPin = false;
    resetUI();
    showActions();
  }

  // Oubli PIN (idem)
  function forgotPin() {
    resetUI();
    document.getElementById('forgotPinPanel').style.display = "block";
    document.getElementById('forgotPinText').innerText = t('forgotPinText');
    html5QrCodeForgot = new Html5Qrcode("forgotReader");
    html5QrCodeForgot.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        if(decodedText === currentCard) {
          html5QrCodeForgot.stop();
          let data = JSON.parse(localStorage.getItem("card-" + currentCard));
          if(data) {
            delete data.pin;
            localStorage.setItem("card-" + currentCard, JSON.stringify(data));
            alert("🔓 PIN désactivé pour cette carte !");
          }
          resetUI();
          showActions();
        }
      },
      (errorMessage) => {
        document.getElementById('forgotPinText').innerText = t('forgotPinText') + " " + errorMessage;
      }
    );
  }
  function cancelForgotPin() {
    if(html5QrCodeForgot) {
      html5QrCodeForgot.stop();
    }
    resetUI();
    showActions();
  }

  // Affiche lecture (idem)
  function proceedAction() {
    resetUI();
    if(currentAction === "read") {
      showRead();
    } else if(currentAction === "edit") {
      showForm();
    }
  }
  function showRead() {
    const saved = localStorage.getItem("card-" + currentCard);
    let info = saved ? JSON.parse(saved) : null;
    let text = "";
    if(info) {
      for(let key in info) {
        if(key !== "pin") text += `${key} : ${info[key]}\n`;
      }
    } else {
      text = t('noData');
    }
    document.getElementById('readInfo').innerText = text;
    document.getElementById('readBox').style.display = "block";
  }
  function closeRead() {
    resetUI();
    showActions();
  }

  // Formulaire édition (idem)
  function showForm() {
    const saved = localStorage.getItem("card-" + currentCard);
    let info = saved ? JSON.parse(saved) : {};
    document.getElementById('firstName').value = info.firstName || "";
    document.getElementById('lastName').value = info.lastName || "";
    document.getElementById('email').value = info.email || "";
    document.getElementById('phone').value = info.phone || "";
    document.getElementById('pin').value = "";
    document.getElementById('formContainer').style.display = "block";
  }
  function closeForm() {
    resetUI();
    showActions();
  }

  function saveData() {
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const pin = document.getElementById('pin').value.trim();

    localStorage.setItem("card-" + currentCard, JSON.stringify({firstName,lastName,email,phone,pin: pin || undefined}));
    alert(t('dataSaved'));
    resetUI();
    showActions();
    updateCounter();
  }

  function rescan() {
    resetUI();
    currentCard = null;
    currentAction = null;
    startScan();
  }

  function manualEntry() {
    resetUI();
    const num = prompt(t('enterCardNum'));
    if(num) {
      currentCard = num;
      showActions();
    }
  }

  function startDelete() {
    resetUI();
    document.getElementById('deletePanel').style.display = "block";
  }
  function closeDelete() {
    resetUI();
  }
  function startScanForDelete() {
    resetUI();
    document.getElementById('status').innerText = t('scanning');
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        html5QrCode.stop();
        currentCard = decodedText;
        askDeleteConfirm();
      },
      (errorMessage) => {
        document.getElementById('status').innerText = t('scanning') + " " + errorMessage;
      }
    );
  }
  function manualDeleteEntry() {
    resetUI();
    const num = prompt(t('enterCardNum'));
    if(num) {
      currentCard = num;
      askDeleteConfirm();
    } else {
      startDelete();
    }
  }
  function askDeleteConfirm() {
    resetUI();
    document.getElementById('confirmDeleteText').innerText = t('deleteConfirm') + currentCard + " ?";
    document.getElementById('confirmDeletePanel').style.display = "block";
  }
  function confirmDelete(ok) {
    if(ok) {
      localStorage.removeItem("card-" + currentCard);
      alert(t('cardDeleted'));
      currentCard = null;
      resetUI();
      updateCounter();
    } else {
      resetUI();
      startDelete();
    }
  }

  // Réglages (affichage en bas)
  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    if(panel.style.display === "block") {
      panel.style.display = "none";
    } else {
      panel.style.display = "block";
    }
  }

  // Thème clair/sombre
  function toggleTheme() {
    if(document.body.style.filter === "invert(1)") {
      document.body.style.filter = "";
    } else {
      document.body.style.filter = "invert(1)";
    }
  }

  // Changer langue
  function changeLanguage(lang) {
    document.documentElement.lang = lang;
    updateTexts();
    updateCounter();
  }

  // NFC Web API (Android only)
  async function startNfcScan() {
    if (!('NDEFReader' in window)) {
      alert("NFC non supporté sur ce navigateur.");
      return;
    }
    try {
      const ndef = new NDEFReader();
      await ndef.scan();
      ndef.onreading = event => {
        const decoder = new TextDecoder();
        let nfcId = "";
        if(event.serialNumber) {
          nfcId = event.serialNumber;
        } else if(event.message.records.length) {
          nfcId = decoder.decode(event.message.records[0].data);
        }
        if(nfcId) {
          currentCard = nfcId;
          showActions();
          ndef.onreading = null;
          ndef.abort();
        }
      };
      alert("📶 Approchez une carte NFC...");
    } catch(e) {
      alert("Erreur NFC : " + e);
    }
  }

  // Gestion du choix Apple / Android
  document.getElementById('btnApple').onclick = () => {
    document.getElementById('deviceChoice').style.display = "none";
    document.getElementById('mainContent').style.display = "block";
    // iPhone : cacher bouton NFC
    document.getElementById('nfcScanBtn').style.display = "none";
    // Langue par défaut FR (ou détecter navigateur ?)
    document.documentElement.lang = navigator.language.startsWith('fr') ? 'fr' : 'en';
    updateTexts();
    updateCounter();
  };
  document.getElementById('btnAndroid').onclick = () => {
    document.getElementById('deviceChoice').style.display = "none";
    document.getElementById('mainContent').style.display = "block";
    // Android : afficher bouton NFC
    document.getElementById('nfcScanBtn').style.display = "inline-block";
    document.documentElement.lang = navigator.language.startsWith('fr') ? 'fr' : 'en';
    updateTexts();
    updateCounter();
  };

  // Au chargement initial, afficher page choix
  window.onload = () => {
    document.getElementById('deviceChoice').style.display = "block";
    document.getElementById('mainContent').style.display = "none";
  };

</script>

</body>
- [ ] </html>
